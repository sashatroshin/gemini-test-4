# Требования к продукту (PRD): Онлайн-форма для отчёта по смене

## 1. Введение и Видение

**Видение продукта:** Создать стильную, современную и интуитивно понятную онлайн-форму, которая упрощает и автоматизирует процесс ежедневного закрытия кассовой смены. Приложение должно минимизировать ошибки персонала за счет автоматических расчетов и предоставлять понятные инструкции в случае расхождений.

## 2. Цели и Задачи

- **Автоматизация:** Устранить ручные расчеты и уменьшить количество ошибок.
- **Эффективность:** Ускорить процесс закрытия смены.
- **Интеграция:** Обеспечить автоматическую отправку данных в систему n8n для дальнейшей обработки.
- **Простота:** Предоставить сотрудникам простой и понятный интерфейс, не требующий специального обучения. Позволить владельцу просто менять данные на странице и логику через файл конфигурации.

## 3. Целевая Аудитория

- Кассиры, администраторы и менеджеры, ответственные за закрытие смены и финансовую отчетность.

## 4. Технологический Стек

### Frontend

- Тип: Одностраничное приложение (SPA) без фреймворков
- HTML, CSS, JavaScript


### Backend Integration

- API Integration: Fetch API (нативный JavaScript)
- Webhook Target: n8n workflow endpoint
- Формат данных: JSON

###Development & Deployment

- Хранение кода: GitHub Repository
- IDE: Trae + Google Gemini
- Развертывание: Easypanel (автодеплой из GitHub)
- Хостинг: Свой VPS через Easypanel
- SSL: Let's Encrypt (автоматически через Easypanel)

### Automation & Workflows

- Backend Logic: n8n (обработка данных, интеграции)
- CI/CD: GitHub Actions (опционально для линтинга)

## 5. Дизайн и Пользовательский Опыт (UX)

- **Визуальный стиль:** Стильный, современный, минималистичный, лёгкий. Чистый интерфейс с акцентом на удобство использования.
- **Структура страницы:**
    - **Левая колонка (2/3 ширины):** Область для ввода данных.
    - **Правая колонка (1/3 ширины):** "Сводка за смену" — область для отображения расчетных итогов и сообщений. Sticky note.
- **Поведение полей ввода:**
    - Поля для ввода сумм поддерживают математический оператор `+`.
    - **Активное поле (в фокусе):** Отображает введенное выражение (например, `15000+250+100`).
    - **Неактивное поле:** Отображает итоговую вычисленную сумму (например, `15350`).
    - При вводе других символов кроме + и цифр подсвечиваем поле красным.

## 6. Функциональные Требования

### 6.1. Файл Конфигурации (`config.json`)

Все настройки приложения должны храниться в едином файле `config.json` в корне проекта.

```json
{
  "webhookUrl": "URL_вашего_вебхука_в_n8n",
  "businessDate": {
    "changeTime": "09:00",
    "timezone": "Asia/Irkutsk"
  },
  "expenseCategories": [
    "ОХРАНА",
    "ТАКСИ",
    "ХОЗТОВАРЫ",
    "ПРОДУКТЫ"
  ],
  "messages": {
    "cashSurplus": {
      "title": "Излишек наличных",
      "template": "В кассе на {amount} больше. Рассчитали гостей и забыли забить в кассу. Создайте новый заказ, забейте в него спецзаказ на эту сумму."
    },
    "cashShortage": {
      "title": "Недостача наличных",
      "template": "В кассе не хватает {amount}. Необходимо покрыть недостачу. Создайте новый заказ, забейте в него спецзаказ на эту сумму."
    },
    "cashlessDiscrepancyNegative": {
      "title": "Расхождение по безналу",
      "template": "По данным учёта безналичная выручка на {amount} больше, чем фактические поступления. Вероятно, не провели оплату по терминалу. Необходимо снять со своих."
    },
    "cashlessDiscrepancyPositive": {
      "title": "Расхождение по безналу",
      "template": "Фактическая безналичная выручка на {amount} больше, чем по данным учёта. Вероятно, забыли провести заказ. Создайте новый заказ и забейте в него спецзаказ на эту сумму."
    }
  }
}
```

### 6.2. Поля для Ввода Данных

#### Блок 1: Размен
- **Размен в кассе на начало смены** (`razmen`)

#### Блок 2: Расходы
- Кнопка **"Добавить расход"**.
- При нажатии добавляется группа полей:
    - **Сумма** (`summa`)
    - **Категория** (`kategoriya`): выпадающий список, значения из `expenseCategories` в `config.json`.
    - **Комментарий** (`komment`)
- Количество расходов не ограничено.

#### Блок 3: Отчёт из Presto
- **Наличные Presto** (`presto_nalichnie`)
- **Карты Presto** (`presto_karti`)
- **Возвраты Presto** (`presto_vozvrati`): *информационное поле, в расчетах не участвует.*
- **Доставка** (`dostavka`)
- **Самовывоз UDS** (`samovivoz`)

#### Блок 4: Фактическая выручка
- **Всего наличных в кассе** (`nalichnie_vsego`): включая размен.
- **Сверки по терминалам** (`terminal_sverka`): карты + СБП.

### 6.3. Основная Логика

- **Смена Бизнес-Даты:** Бизнес-дата автоматически меняется каждый день в `09:00` по иркутскому времени (согласно `config.json`).
- При внесении изменений в форму необходимо проверять не закончилась ли бизнес дата. Если закончилась, то необходимо перезагрузить страницу с новой бизнес датой и пустыми полями ввода.
- **Автосохранение:** Все введенные данные автоматически сохраняются в локальном хранилище браузера для текущей бизнес-даты. При перезагрузке страницы данные не теряются.
- **Отправка по Вебхуку:** Через 1 минуту после последнего изменения данных, форма собирает все данные в JSON-объект и отправляет его методом `POST` на `webhookUrl` из `config.json`.

### 6.4. Расчеты и Сводка

Эта информация отображается в правой колонке "Сводка за смену".

- **Текущая бизнес дата** (`buisnessdate`)
- **Общие расходы** (`obschie_rashodi`): Сумма всех добавленных расходов.
- **Ожидаемые наличные** (`ozhidaemie_nalichnie`): `razmen + presto_nalichnie - obschie_rashodi`
- **Разница по наличным** (`raznica_nalichnie`): `nalichnie_vsego - ozhidaemie_nalichnie`
- **Факт по безналу** (`fakt_beznal`): `terminal_sverka + dostavka + samovivoz`
- **Разница по безналу** (`raznica_beznal`): `fakt_beznal - presto_karti`
- **Общая выручка** (`obschaya_vyruchka`): `presto_nalichnie + presto_karti`
- **Чистая выручка наличными** (`chistie_nalichnie`): `ozhidaemie_nalichnie - razmen`

### 6.5. Обработка Расхождений

Система анализирует поля `raznica_nalichnie` и `raznica_beznal` и выводит соответствующие сообщения из `config.json` в сводке.

- **`raznica_nalichnie > 0`**: Сообщение `cashSurplus`.
- **`raznica_nalichnie < 0`**: Сообщение `cashShortage`.
- **`raznica_beznal > 0`**: Сообщение `cashlessDiscrepancyPositive`.
- **`raznica_beznal < 0`**: Сообщение `cashlessDiscrepancyNegative`.

В шаблоне сообщения `{amount}` заменяется на абсолютное значение разницы.

## 7. Формат Данных для Вебхука

Пример итогового JSON, отправляемого на вебхук:

```json
{
  "shiftReport": {
    "date": "28.08.2025",
    "buisnessdate": "22.08.2025"
  },
  "fields": {
    "razmen": "15260",
    "nalichnie_vsego": "25455",
    "dostavka": "0",
    "samovivoz": "665",
    "presto_nalichnie": "13695",
    "presto_karti": "176766",
    "presto_vozvrati": "900",
    "terminal_sverka": "176101"
  },
  "rashodi": [
    {
      "summa": 3500,
      "kategoriya": "ОХРАНА",
      "komment": "фейсер"
    }
  ],
  "status": "test"
}
```

В JSON так же передаётся ключ status, значение которого можно менять через файл конфигурации. Он отвечает за тестирование системы.